version: '1.0'
steps:

  InitVariables:
    title: Init variables
    commands:
      - cf_export GIT_BRANCH=${{CF_BRANCH}}

  BuildImage:
    type: build
    title: Building Image
    description: Building Jenkins Master Image
    working_directory: jenkins
    image_name: ppavlov/jenkins-master
    tag: ${{CF_BRANCH}}

  PushToRegistry:
    type: push
    candidate: ${{BuildImage}}
    tag: ${{CF_BRANCH}}
    image_name: ppavlov/jenkins-master
    registry: quay
    fail_fast: false

  PushImageLatest:
   type: push
   title: Push image with latest tag
   candidate: ${{BuildImage}}
   tag: latest
   registry: quay
   when:
     condition:
       all:
         executeForMasterBranch: "'${{CF_BRANCH}}' == 'master'"

  update-branch-protection:
   title: Add "Staging Environment" status check to the branch
   image: cloudposse/github-status-updater
   environment:
     - GITHUB_ACTION=update_branch_protection
     - GITHUB_TOKEN=${{GITHUB_TOKEN}}
     - GITHUB_OWNER=${{CF_REPO_OWNER}}
     - GITHUB_REPO=${{CF_REPO_NAME}}
     - GITHUB_REF=${{CF_BRANCH}}
     - GITHUB_CONTEXT=Staging Environment
   when:
     condition:
       all:
         executeForBranch: "'${{CF_BRANCH}}' != ''"

  set-deployment-status-to-pending:
   title: Set "Staging Environment" deployment status to "pending"
   image: cloudposse/github-status-updater
   environment:
     - GITHUB_ACTION=update_state
     - GITHUB_TOKEN=${{GITHUB_TOKEN}}
     - GITHUB_OWNER=${{CF_REPO_OWNER}}
     - GITHUB_REPO=${{CF_REPO_NAME}}
     - GITHUB_REF=${{CF_REVISION}}
     - GITHUB_CONTEXT=Staging Environment
     - GITHUB_STATE=pending
     - GITHUB_DESCRIPTION=Deploying changes to ${{FEATURE}} namespace
     - GITHUB_TARGET_URL=http://jenkins.traefik/

  set-deployment-status-to-success:
   title: Set "Staging Environment" deployment status to "success"
   image: cloudposse/github-status-updater
   environment:
     - GITHUB_ACTION=update_state
     - GITHUB_TOKEN=${{GITHUB_TOKEN}}
     - GITHUB_OWNER=${{CF_REPO_OWNER}}
     - GITHUB_REPO=${{CF_REPO_NAME}}
     - GITHUB_REF=${{CF_REVISION}}
     - GITHUB_CONTEXT=Staging Environment
     - GITHUB_STATE=success
     - GITHUB_DESCRIPTION=Deployed to ${{FEATURE}} namespace
     - GITHUB_TARGET_URL=http://jenkins.traefik/
